<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Service History - Client</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    .service-list {
      list-style: none;
      padding: 0;
      max-width: 600px;
      margin: 20px auto;
    }
    .service-item {
      border: 1px solid #ccc;
      padding: 12px;
      margin-bottom: 10px;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="navbar-logo">
      <img src="ReparaJaLogo.png" alt="ReparaJá Logo" style="height: 30px; vertical-align: middle; margin-right: 8px; background: transparent;" />
      ReparaJá
    </div>
    <ul class="navbar-links">
      <li><a href="client-dashboard.html">Dashboard</a></li>
      <li><a href="schedule-service.html">Schedule Service</a></li>
      <li><a href="booked-services.html">Booked Services</a></li>
      <li><a href="service-history-client.html" class="active">Service History</a></li>
      <li><a href="account-info-client.html">Account Info</a></li>
      <li><a href="login-client.html" id="logoutBtn">Logout</a></li>
    </ul>
  </nav>

  <main class="main-content">
    <h1>Your Service History</h1>
    <ul id="serviceList" class="service-list">
      <!-- Client's completed services will be listed here -->
    </ul>
  </main>

  <div id="modalOverlay" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
    <div id="modal" style="background:white; padding:20px; border-radius:8px; max-width:400px; width:90%; box-shadow:0 2px 10px rgba(0,0,0,0.3);">
      <div id="modalContent"></div>
      <div style="margin-top:15px; text-align:right;">
        <button id="modalCancelBtn" style="margin-right:10px; padding:5px 10px;">Cancel</button>
        <button id="modalOkBtn" style="padding:5px 10px;">OK</button>
      </div>
    </div>
  </div>

  <script>
    // Load completed services from localStorage filtered by logged-in client
    const serviceList = document.getElementById('serviceList');
    const modalOverlay = document.getElementById('modalOverlay');
    const modalContent = document.getElementById('modalContent');
    const modalCancelBtn = document.getElementById('modalCancelBtn');
    const modalOkBtn = document.getElementById('modalOkBtn');

    let modalResolve;
    function showModal(contentHtml) {
      modalContent.innerHTML = contentHtml;
      modalOverlay.style.display = 'flex';
      return new Promise((resolve) => {
        modalResolve = resolve;
      });
    }

    modalCancelBtn.addEventListener('click', () => {
      modalOverlay.style.display = 'none';
      modalResolve(false);
    });

    modalOkBtn.addEventListener('click', () => {
      modalOverlay.style.display = 'none';
      modalResolve(true);
    });

    function getCompletedServices() {
      const loggedClient = sessionStorage.getItem('loggedClient') || 'exampleClient';
      const services = localStorage.getItem('completedServices');
      if (services) {
        const parsedServices = JSON.parse(services);
        const hasClientData = parsedServices.some(s => s.client === loggedClient);
        if (!hasClientData) {
          return resetExampleServices(loggedClient);
        }
        return parsedServices;
      } else {
        return resetExampleServices(loggedClient);
      }
    }

    function resetExampleServices(client) {
      const exampleServices = [
        {
          id: 1,
          client: client,
          technician: 'John Doe',
          description: 'Repaired smartphone screen',
          category: 'Electronics',
          date: '2023-05-10',
          evaluation: 4,
          completed: true
        },
        {
          id: 2,
          client: client,
          technician: 'Jane Smith',
          description: 'Fixed laptop charging port',
          category: 'Computers',
          date: '2023-04-22',
          evaluation: null,
          completed: false
        },
        {
          id: 3,
          client: client,
          technician: 'Mike Brown',
          description: 'Replaced washing machine motor',
          category: 'Appliances',
          date: '2023-03-15',
          evaluation: null,
          completed: true
        },
        {
          id: 4,
          client: client,
          technician: 'Anna White',
          description: 'Fixed refrigerator cooling issue',
          category: 'Appliances',
          date: '2023-02-28',
          evaluation: 5,
          completed: true
        }
      ];
      localStorage.setItem('completedServices', JSON.stringify(exampleServices));
      return exampleServices;
    }

    function getLoggedClient() {
      return sessionStorage.getItem('loggedClient') || 'exampleClient';
    }

    async function promptRating(serviceId) {
      const contentHtml = `
        <p>Please enter your rating (1-5):</p>
        <input type="number" id="ratingInput" min="1" max="5" style="width: 100%; padding: 5px; font-size: 1rem;" />
      `;
      const confirmed = await showModal(contentHtml);
      if (confirmed) {
        const ratingInput = document.getElementById('ratingInput');
        const rating = parseFloat(ratingInput.value);
        if (!isNaN(rating) && rating >= 1 && rating <= 5) {
          saveEvaluation(serviceId, rating);
        } else {
          alert('Invalid rating. Please enter a number between 1 and 5.');
        }
      }
    }

    async function confirmAction(message) {
      const contentHtml = `<p>${message}</p>`;
      return await showModal(contentHtml);
    }

    function renderServices() {
      serviceList.innerHTML = '';
      const loggedClient = getLoggedClient();
      if (!loggedClient) {
        serviceList.innerHTML = '<li>Please log in to view your service history.</li>';
        return;
      }
      const completedServices = getCompletedServices().filter(s => s.client === loggedClient);
      if (completedServices.length === 0) {
        serviceList.innerHTML = '<li>No completed services found.</li>';
        return;
      }
      completedServices.forEach(service => {
        const li = document.createElement('li');
        li.className = 'service-item';
        li.innerHTML = `
          <strong>Technician:</strong> ${service.technician}<br/>
          <strong>Description:</strong> ${service.description}<br/>
          <strong>Category:</strong> ${service.category || 'General'}<br/>
          <strong>Date:</strong> ${service.date}<br/>
          <strong>Evaluation:</strong> ${service.evaluation ? service.evaluation + ' / 5' : 'Not evaluated yet'}<br/>
          ${!service.evaluation ? `<button class="evaluate-btn" data-id="${service.id}">Evaluate</button>` : ''}
          ${!service.evaluation ? `<button class="reject-btn" data-id="${service.id}">Reject</button>` : ''}
          ${!service.completed ? `<button class="confirm-btn" data-id="${service.id}">Confirm Completion</button>` : ''}
        `;
        serviceList.appendChild(li);
      });

      // Add event listeners for evaluation buttons
      document.querySelectorAll('.evaluate-btn').forEach(button => {
        button.addEventListener('click', () => {
          const serviceId = button.getAttribute('data-id');
          promptRating(serviceId);
        });
      });

      // Add event listeners for reject buttons
      document.querySelectorAll('.reject-btn').forEach(button => {
        button.addEventListener('click', async () => {
          const serviceId = button.getAttribute('data-id');
          const confirmed = await confirmAction('Are you sure you want to reject this completed service? You will be redirected to contact support.');
          if (confirmed) {
            rejectService(serviceId);
          }
        });
      });

      // Add event listeners for confirm completion buttons
      document.querySelectorAll('.confirm-btn').forEach(button => {
        button.addEventListener('click', async () => {
          const serviceId = button.getAttribute('data-id');
          const confirmed = await confirmAction('Do you confirm the completion of this service?');
          if (confirmed) {
            markServiceCompleted(serviceId);
          }
        });
      });
    }

    function markServiceCompleted(serviceId) {
      const services = getCompletedServices();
      const index = services.findIndex(s => s.id == serviceId);
      if (index !== -1) {
        services[index].completed = true;
        localStorage.setItem('completedServices', JSON.stringify(services));
        renderServices();
        confirmAction('Would you like to evaluate the service now?').then(confirmed => {
          if (confirmed) {
            promptRating(serviceId);
          }
        });
      }
    }

    function saveEvaluation(serviceId, rating) {
      const services = getCompletedServices();
      const index = services.findIndex(s => s.id == serviceId);
      if (index !== -1) {
        services[index].evaluation = rating;
        localStorage.setItem('completedServices', JSON.stringify(services));
        renderServices();
      }
    }

    renderServices();

    // Logout button functionality
    document.getElementById('logoutBtn').addEventListener('click', function() {
      sessionStorage.removeItem('loggedClient');
    });

    function rejectService(serviceId) {
      // Redirect to contact support page
      window.location.href = 'contact-public.html';
    }
  </script>
</body>
</html>
